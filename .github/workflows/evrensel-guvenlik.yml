name: Evrensel Guvenlik Fabrikasi ðŸ­

on:
  push:
    branches: [ "main" ]

jobs:
  build-scan-sign:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      # 1. KodlarÄ± Ã‡ek
      - name: Kodlari Cek
        uses: actions/checkout@v4

      # 2. AraÃ§larÄ± Kur (Bunlar her dil iÃ§in aynÄ±dÄ±r)
      - name: Cosign Kur
        uses: sigstore/cosign-installer@v3.3.0

      - name: Syft Kur
        uses: anchore/sbom-action/download-syft@v0.15.0

      # 3. Ä°maj Ä°smini Otomatik Belirle (SÄ°HÄ°RLÄ° KISIM âœ¨)
      # Proje ismini alÄ±p kÃ¼Ã§Ã¼k harfe Ã§eviriyoruz (Docker bÃ¼yÃ¼k harf sevmez)
      - name: Imaj Ismini Belirle
        id: image_name
        run: |
          echo "IMAGE=ttl.sh/${{ github.event.repository.name }}:${{ github.sha }}" >> $GITHUB_ENV

      # 4. Minimal Ä°maj OluÅŸtur (Dili Dockerfile belirler, biz karÄ±ÅŸmayÄ±z)
      - name: Docker Build
        run: docker build -t ${{ env.IMAGE }} .

      # 5. SBOM OluÅŸtur
      - name: SBOM Olustur
        run: syft ${{ env.IMAGE }} -o spdx-json > sbom.json

      # 6. KanÄ±tÄ± Kaydet
      - name: SBOM DosyasÄ±nÄ± YÃ¼kle
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.event.repository.name }}
          path: sbom.json

      # 7. Ä°majÄ± GÃ¶nder
      - name: Push
        run: docker push ${{ env.IMAGE }}

      # 8. Ä°mzala
      - name: Sign
        run: |
          cosign sign --yes --key env://COSIGN_PRIVATE_KEY ${{ env.IMAGE }}
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}

      # 9. DoÄŸrula
      - name: Verify
        run: |
           cosign verify --key cosign.pub ${{ env.IMAGE }}